Insert in this file the history of DB Schema, only for Oracle Database
Every items must have:
- The Developer who has made the change
- The SQL script that updates the schema ( schema, index and FK )
- The Date

-- ##################################################################################################

-- 23.02.2015 Francesco Lucchi ORA_drop.sql: added DROP statement for SBI_OBJ_DATA_SET table.

-- 23.02.2015 Francesco Lucchi Athena_ORA_create.sql: fixed constraint definition for SBI_DATA_SET, SBI_PARUSE, SBI_PARAMETERS tables.

-- 23.02.2015 Francesco Lucchi: removed SBI_DOSSIER_* tables.

-- 06.05.2016 Alessandro Portosa: Renamed HIBERNATE_SEQUENCES and its fields with lowercase. It must be lowercase for Unix compatibility

--09.05.2016 Giulio Gavardi
ALTER TABLE SBI_OBJECTS ADD COLUMN LOCKED_BY_USER VARCHAR2(100) NULL;

-- 26.05.2016 Salvatore Lupo
ALTER TABLE SBI_ALERT ADD COLUMN SINGLE_EXECUTION VARCHAR2(1),
ADD COLUMN EVENT_BEFORE_TRIGGER_ACTION INTEGER;

-- 02.06.2016. Ana Tomic, Nikola Simovic
CREATE TABLE SBI_FUNCTIONS_ORGANIZER (
	FUNCT_ID INTEGER NOT NULL ,
	PARENT_FUNCT_ID INTEGER,
	NAME VARCHAR2 (40),
	DESCR VARCHAR2 (160),
	PATH VARCHAR2 (400),
	CODE VARCHAR2 (40) NOT NULL ,
	PROG INTEGER NOT NULL ,
	USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP              VARCHAR2(100),
    USER_DE              VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN       VARCHAR2(10),
    SBI_VERSION_UP       VARCHAR2(10),
    SBI_VERSION_DE       VARCHAR2(10),
    META_VERSION         VARCHAR2(100),
    ORGANIZATION         VARCHAR2(20),
CONSTRAINT XAK1SBI_FUNCTIONS_ORGANIZER UNIQUE (CODE, USER_IN),
PRIMARY KEY (FUNCT_ID)
);

CREATE TABLE SBI_OBJ_FUNC_ORGANIZER (
	BIOBJ_ID INTEGER NOT NULL ,
	FUNCT_ID INTEGER NOT NULL ,
	PROG INTEGER,
	USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP              VARCHAR2(100),
    USER_DE              VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN       VARCHAR2(10),
    SBI_VERSION_UP       VARCHAR2(10),
    SBI_VERSION_DE       VARCHAR2(10),
    META_VERSION         VARCHAR2(100),
    ORGANIZATION         VARCHAR2(20),
PRIMARY KEY (BIOBJ_ID,FUNCT_ID)
);

ALTER TABLE SBI_FUNCTIONS_ORGANIZER ADD CONSTRAINT FK_SBI_FUNCTIONS_ORGANIZER_1 FOREIGN KEY (PARENT_FUNCT_ID) REFERENCES SBI_FUNCTIONS_ORGANIZER (FUNCT_ID);
ALTER TABLE SBI_OBJ_FUNC_ORGANIZER ADD CONSTRAINT FK_SBI_OBJ_FUNC_ORGANIZER_1 FOREIGN KEY (FUNCT_ID) REFERENCES SBI_FUNCTIONS_ORGANIZER (FUNCT_ID);
ALTER TABLE SBI_OBJ_FUNC_ORGANIZER ADD CONSTRAINT FK_SBI_OBJ_FUNC_ORGANIZER_2 FOREIGN KEY (BIOBJ_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID) ON DELETE CASCADE;

-- 08.06.2016. Alessandro Portosa
ALTER TABLE SBI_CATALOG_FUNCTION ADD DESCRIPTION CLOB NOT NULL;

-- 09.06.2016 Vincenzo Gambino
ALTER TABLE SBI_PARUSE ADD COLUMN OPTIONS VARCHAR(4000) NULL DEFAULT NULL

--10.06.2016 Antonella Giachino: add hierarchy_name, level and member_name in SBI_GEO_MAP
ALTER TABLE  SBI_GEO_MAPS ADD HIERARCHY_NAME VARCHAR2(100);
ALTER TABLE  SBI_GEO_MAPS ADD LEVEL INTEGER;
ALTER TABLE  SBI_GEO_MAPS ADD MEMBER_NAME VARCHAR2(100);

-- 15.6.2016 Antonella: deleted WORSKSHEET engine - clean db from its user func and engines
alter table SBI_USER_FUNC disable constraint 'FK_PRODUCT_TYPE';
delete from SBI_USER_FUNC  where name = 'CreateWorksheetFromDatasetUserFunctionality';
alter table SBI_USER_FUNC enable constraint 'FK_PRODUCT_TYPE';

alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_1';
alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_2';
alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_3';
DELETE FROM SBI_OBJECTS WHERE ENGINE_ID = (select engine_id from SBI_ENGINES  where name = 'Worksheet Engine');
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_1';
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_2';
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_3';

alter table SBI_ENGINES disable constraint 'FK_SBI_ENGINES_1';
alter table SBI_ENGINES disable constraint 'FK_SBI_ENGINES_2';
delete from SBI_ENGINES  where name = 'Worksheet Engine';
alter table SBI_ENGINES enable constraint 'FK_SBI_ENGINES_1';
alter table SBI_ENGINES enable constraint 'FK_SBI_ENGINES_2';
-- not fk to disable for domains:
delete from SBI_DOMAINS where value_cd = 'WORKSHEET';

-- 22.06.2016 Antonella: rename LEVEL column to NUM_LEVEL
 ALTER TABLE SBI_GEO_MAPS RENAME COLUMN LEVEL TO NUM_LEVEL;

-- 27.06.2016 Francesco Lucchi: grant functionalities ConfigManagement & DomainManagement to superadmin only
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME = 'ConfigManagement');
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME = 'DomainManagement');
DELETE FROM SBI_USER_FUNC WHERE NAME = 'ConfigManagement';
DELETE FROM SBI_USER_FUNC WHERE NAME = 'DomainManagement';


-- 05.07.2016 Vincenzo Gambino: add column FILE_MODEL in SBI_META_MODELS_VERSIONS
ALTER TABLE SBI_META_MODELS_VERSIONS MODIFY CONTENT BLOB;
ALTER TABLE SBI_META_MODELS_VERSIONS ADD FILE_MODEL BLOB NULL;


-- 13.07.2016 Alessandro Piovani: add column ADDITIONAL_INFO in SBI_OBJ_METACONTENT
ALTER TABLE SBI_OBJ_METACONTENTS ADD ADDITIONAL_INFO VARCHAR2(255) DEFAULT NULL;

-- 14.07.2016 Alessandro Piovani: added some columns an constraints to SBI_CATALOG_FUNCTIONS table
ALTER TABLE SBI_CATALOG_FUNCTION
ADD OWNER 	VARCHAR(50) NOT NULL,
ADD KEYWORDS VARCHAR(255) DEFAULT NULL;

ALTER TABLE SBI_CATALOG_FUNCTION
ADD LABEL VARCHAR(50) NOT NULL;

ALTER TABLE SBI_CATALOG_FUNCTION
ADD CONSTRAINT UNIQUE_LABEL_ORG UNIQUE (LABEL,ORGANIZATION);

ALTER TABLE SBI_CATALOG_FUNCTION
ADD TYPE VARCHAR(50) DEFAULT NULL;

CREATE TABLE SBI_WHATIF_WORKFLOW(
	ID INTEGER,
    MODEL_ID INTEGER,
    USER_ID INTEGER,
    SEQUENCE INTEGER,
    STATE VARCHAR2(20),
    NOTES VARCHAR2(100),
    INFO VARCHAR2(100),
    USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP VARCHAR2(100),
    USER_DE VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN VARCHAR2(10),
    SBI_VERSION_UP VARCHAR2(10),
    SBI_VERSION_DE VARCHAR2(10),
    ORGANIZATION VARCHAR2(20),
    PRIMARY KEY (ID)
);

ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_MODEL_WORKFLOW			FOREIGN KEY (MODEL_ID) 			REFERENCES SBI_ARTIFACTS(ID)					ON DELETE CASCADE;
ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_USER_WORKFLOW			FOREIGN KEY (USER_ID) 				REFERENCES SBI_USER(ID) ON DELETE CASCADE;

-- 09.08.2016 Alberto Ghedin: refactoring whatif start actions
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startolap" where label = "knowageolapengine";
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startwhatif" where label = "knowagewhatifengine";

-- 31.08.2016 Marco Cortella: changed foreign keys (delete policy) used by Business Model Catalog and Metadata import
ALTER TABLE SBI_META_TABLE_BC
	DROP CONSTRAINT FK_SBI_META_TABLE_BC_2;
ALTER TABLE SBI_META_TABLE_BC
	ADD CONSTRAINT FK_SBI_META_TABLE_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;

ALTER TABLE SBI_META_BC
	DROP CONSTRAINT FK_SBI_META_BC_1;
ALTER TABLE SBI_META_BC
	ADD CONSTRAINT FK_SBI_META_BC_1 FOREIGN KEY (MODEL_ID) REFERENCES SBI_META_MODELS (ID) ON DELETE CASCADE;

ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;

ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2 FOREIGN KEY (COLUMN_ID) REFERENCES SBI_META_TABLE_COLUMN (COLUMN_ID) ON DELETE CASCADE;

ALTER TABLE SBI_META_DS_BC
	DROP CONSTRAINT FK_SBI_META_DS_BC_2;
ALTER TABLE SBI_META_DS_BC
	ADD CONSTRAINT FK_SBI_META_DS_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;


-- 14.09.2016 Alessandro Piovani: add url, remote columns to SBI_CATALOG_FUNCTIONS and make SCRIPT field nullable

ALTER TABLE SBI_CATALOG_FUNCTION ADD COLUMN REMOTE SMALLINT DEFAULT 0;
ALTER TABLE SBI_CATALOG_FUNCTION ADD COLUMN URL VARCHAR(100);
ALTER TABLE SBI_CATALOG_FUNCTION CHANGE COLUMN SCRIPT SCRIPT TEXT NULL;

-- 14.10.2016 S.Lupo: fixed numeric precision of threshold value
ALTER TABLE SBI_KPI_THRESHOLD_VALUE MODIFY MIN_VALUE NUMBER(18,5);
ALTER TABLE SBI_KPI_THRESHOLD_VALUE MODIFY MAX_VALUE NUMBER(18,5);

-- 7.11.2016 Giulio Gavardi
ALTER TABLE SBI_OUTPUT_PARAMETER ADD COLUMN IS_USER_DEFINED SMALLINT NULL DEFAULT 0;

-- Alessandro Piovani
CREATE TABLE SBI_FUNCTION_INPUT_FILE (
	FUNCTION_ID INTEGER	NOT NULL,
	FILE_NAME VARCHAR2(100)	NOT NULL,
	FILE_CONTENT BLOB		DEFAULT NULL,
	ALIAS VARCHAR2(45)		DEFAULT NULL,
	USER_IN 				VARCHAR2(100) NOT NULL,
  	USER_UP 				VARCHAR2(100) DEFAULT NULL,
  	USER_DE 				VARCHAR2(100) DEFAULT NULL,
  	TIME_IN 				TIMESTAMP NOT NULL,
  	TIME_UP 				TIMESTAMP DEFAULT NULL,
  	TIME_DE 				TIMESTAMP DEFAULT NULL,
  	SBI_VERSION_IN 			VARCHAR2(10) DEFAULT NULL,
  	SBI_VERSION_UP 			VARCHAR2(10) DEFAULT NULL,
  	SBI_VERSION_DE 			VARCHAR2(10) DEFAULT NULL,
  	ORGANIZATION 			VARCHAR2(20) DEFAULT NULL,
	PRIMARY KEY (FUNCTION_ID, FILE_NAME)
);

ALTER TABLE SBI_FUNCTION_INPUT_FILE ADD CONSTRAINT FK_FUNCTION_INPUT_FILES_2 FOREIGN KEY (FUNCTION_ID) REFERENCES SBI_CATALOG_FUNCTION(FUNCTION_ID);

--30.11.2016 Ana Tomic

CREATE TABLE SBI_ACCESSIBILITY_PREFERENCES (
	 ID INT(11) UNSIGNED NOT NULL,
	 USER_ID INT(11) NOT NULL,
	 ENABLE_UIO TINYINT(1) NOT NULL,
	 ENABLE_RROBOBRAILLE TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_GRAPH_SONIFICATION TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_VOICE TINYINT(1) NULL DEFAULT NULL,
	 PREFERENCES TEXT NULL,
	 USER_IN VARCHAR(100) NULL DEFAULT NULL,
	 USER_UP VARCHAR(100) NULL DEFAULT NULL,
	 USER_DE VARCHAR(100) NULL DEFAULT NULL,
	 TIME_IN TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_UP TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_DE TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 SBI_VERSION_IN VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_UP VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_DE VARCHAR(10) NULL DEFAULT NULL,
	 ORGANIZATION VARCHAR(20) NULL DEFAULT NULL,
	 INDEX FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER (USER_ID),
	PRIMARY KEY (ID),
	CONSTRAINT FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER FOREIGN KEY (USER_ID) REFERENCES SBI_USER (ID) ON UPDATE CASCADE ON DELETE CASCADE
);

-- 10.02.2017 ALberto Ghedin
-- added columns that link a snapshot with schedulation

ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULATION VARCHAR2(100);
ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULER VARCHAR2(100);
ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULATION_START INTEGER;
ALTER TABLE SBI_SNAPSHOTS ADD SEQUENCE INTEGER;

-- 22.02.2017
-- added uniquiness constraint for kpi target

ALTER TABLE SBI_KPI_TARGET ADD CONSTRAINT XAK1SBI_KPI_TARGET UNIQUE (
	NAME,
	ORGANIZATION
);

-- 02.03.2017 Dragan Pirkovic
-- changed path for chart document execution

UPDATE SBI_ENGINES SET MAIN_URL = '/knowagecockpitengine/api/1.0/chart/pages/execute' WHERE LABEL = 'knowagechartengine';

-- 20.03.2017 Marco Cortella
-- added TYPE column for SBI_CROSS_NAVIGATION
ALTER TABLE SBI_CROSS_NAVIGATION ADD TYPE INTEGER;
UPDATE SBI_CROSS_NAVIGATION SET TYPE=0;

-- 09.06.2017 Alessandro Portosa
-- changed package for Alert actions
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.ExecuteETLDocument' WHERE NAME = 'Execute ETL Document';
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.SendMail' WHERE NAME = 'Send mail';

-- 13.07.2017 Francesco Lucchi
-- fix definition length, limiting varchars to 4000 (Oracle upper bound)
ALTER TABLE SBI_KPI_KPI CHANGE COLUMN DEFINITION DEFINITION VARCHAR(4000) NOT NULL;
ALTER TABLE SBI_KPI_RULE CHANGE COLUMN DEFINITION DEFINITION VARCHAR(4000) NOT NULL;

-- 28.09.2017 Dragan Pirkovic
-- adding foreign key from sbi.metamodel.DATA_SOURCE_ID to sbi_data_source.DS_ID
ALTER TABLE SBI_META_MODEL	ADD CONSTRAINT FK_META_MODELS_DS_ID	 FOREIGN KEY (DATA_SOURCE_ID) 	REFERENCES SBI_DATA_SOURCE(DS_ID);

-- 05.10.2017 Alessandro Portosa
-- change column type of SBI_AUDIT.DOC_PARAMETERS from VARCHAR2(4000) to CLOB: it must handle all execution parameters and values
ALTER TABLE SBI_META_MODEL	ADD CONSTRAINT FK_META_MODELS_DS_ID	 FOREIGN KEY (DATA_SOURCE_ID) 	REFERENCES SBI_DATA_SOURCE(DS_ID);

-- 05.10.2017 Alberto Ghedin removed mobile. The engine is not deleted because there can be some chart document in installation
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Chart Engine');
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Cockpit Engine');
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Report Engine');
delete from SBI_ENGINES where NAME='Mobile Chart Engine';
delete from SBI_ENGINES where NAME='Mobile Cockpit Engine';
delete from SBI_ENGINES where NAME='Mobile Report Engine';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_CHART';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_COCKPIT';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_REPORT';
commit;

-- 11.10.2015 Alberto Ghedin added dossier
CREATE TABLE SBI_DOSSIER_ACTIVITY(
		ID 					INTEGER NOT NULL,
		PROGRESS 			INTEGER NOT NULL,
		PPT					BLOB,
	    DOCUMENT_ID 		INTEGER,
	    ACTIVITY 			VARCHAR2(45) NOT NULL,
	    PARAMS 				VARCHAR2(4000),
     	USER_IN 			VARCHAR2(100) NOT NULL,
     	USER_UP 			VARCHAR2(100),
    	USER_DE				VARCHAR2(100),
		TIME_IN 			TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	 	TIME_UP 			TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	 	TIME_DE 			TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
     	SBI_VERSION_IN 		VARCHAR2(10),
     	SBI_VERSION_UP 		VARCHAR2(10),
     	SBI_VERSION_DE 		VARCHAR2(10),
     	ORGANIZATION 		VARCHAR2(20),
	    PRIMARY KEY (ID)
);

ALTER TABLE SBI_DOSSIER_ACTIVITY ADD CONSTRAINT FK_SBI_PROGRESS_THREAD	FOREIGN KEY (PROGRESS) 	REFERENCES SBI_PROGRESS_THREAD(PROGRESS_THREAD_ID);
ALTER TABLE SBI_DOSSIER_ACTIVITY ADD CONSTRAINT FK_SBI_OBJECTS FOREIGN KEY  (DOCUMENT_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID);
--- 24.11.2017 Marco Cortella added Date type in domains for file dataset support
INSERT into SBI_DOMAINS (VALUE_ID, VALUE_CD, VALUE_NM, DOMAIN_CD, DOMAIN_NM,VALUE_DS, USER_IN) values ((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_DOMAINS'), 'Date', 'Date', 'DS_META_VALUE', 'Dataset Metadata Value', 'Dataset Metadata Value', '');
UPDATE hibernate_sequences SET next_val = (SELECT MAX(VALUE_ID) + 1 FROM SBI_DOMAINS) WHERE sequence_name = 'SBI_DOMAINS';


-- 13.03.2018 Giulio Gavardi
-- new column for roles , is_public

ALTER TABLE SBI_EXT_ROLES ADD IS_PUBLIC SMALLINT NULL;


-- 27.04.2018. Predrag Josipovic
-- Added new column into knowage.SBI_DATA_SOURCE table for Advanced JDBC Pool Configuration

ALTER TABLE SBI_DATA_SOURCE ADD JDBC_ADVANCED_CONFIGURATION	VARCHAR2(4000);

-- 29.05.2018. Predrag Josipovic
-- Modifications on Knowage Metadata table SBI_I18N_MESSAGES, added new column ID as Primary Key
--- START ---
ALTER TABLE SBI_I18N_MESSAGES RENAME TO SBI_I18N_MESSAGES_OLD;

CREATE TABLE SBI_I18N_MESSAGES
AS (SELECT CAST(ROWNUM AS NUMBER(38, 0)) ID, M.*
FROM DUAL, SBI_I18N_MESSAGES_OLD M);

DROP TABLE SBI_I18N_MESSAGES_OLD;

ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT PK_SBI_I18N_MESSAGES PRIMARY KEY (ID);
ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT FK_SBI_I18N_MESSAGES FOREIGN KEY (LANGUAGE_CD) REFERENCES SBI_DOMAINS (VALUE_ID);
ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT SBI_I18N_MESSAGES_UNIQUE UNIQUE (LANGUAGE_CD, LABEL, ORGANIZATION);

INSERT INTO hibernate_sequences VALUES ('SBI_I18N_MESSAGES',
                                                            (SELECT NVL(MAX(m.ID) + 1, 1) FROM SBI_I18N_MESSAGES m));
COMMIT;
--- END ---

-- 29.05.2018 Francesco Lucchi
CREATE UNIQUE INDEX XAK2SBI_DATA_SET ON SBI_DATA_SET(NAME, VERSION_NUM, ORGANIZATION);

-- 01.06.2018 Giulio Gavardi

INSERT INTO SBI_CONFIG ( ID, LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID, CATEGORY, USER_IN, TIME_IN) VALUES
((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_CONFIG'),
'KNOWAGE.WORKSPACE_SHOW_GRID', 'Show grid view as default in workspace', 'Show grid view as default in workspace', true, 'true',
(select VALUE_ID from SBI_DOMAINS where VALUE_CD = 'STRING' AND DOMAIN_CD = 'PAR_TYPE'), 'GENERIC_CONFIGURATION', 'biadmin', current_timestamp);
update hibernate_sequences set next_val = next_val+1 where sequence_name = 'SBI_CONFIG';
commit;

-- 06.06.2018 Filip Milosavljevic

ALTER TABLE SBI_ATTRIBUTE ADD COLUMN (LOV_ID INTEGER NULL,ALLOW_USER SMALLINT(6) NULL,MULTIVALUE SMALLINT(6) NULL,SYNTAX SMALLINT(6) NULL,
									  VALUE_TYPE_ID INTEGER NULL, VALUE_TYPE_CD VARCHAR2(20), VALUE_TYPE VARCHAR2(50));
ALTER TABLE SBI_ATTRIBUTE ADD CONSTRAINT FK_LOV FOREIGN KEY (LOV_ID) REFERENCES SBI_LOV(LOV_ID);
ALTER TABLE SBI_ATTRIBUTE ADD CONSTRAINT ENUM_TYPE CHECK (VALUE_TYPE IN('STRING','DATE','NUM'));

ALTER TABLE SBI_ATTRIBUTE MODIFY (DESCRIPTION VARCHAR2(500) NULL);

-- 07.06.2018 Antonella Giachino
DELETE FROM SBI_PRODUCT_TYPE_ENGINE WHERE ENGINE_ID = (
    SELECT ENGINE_ID FROM SBI_ENGINES WHERE BIOBJ_TYPE = (
        SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML'
    )
);

DELETE FROM SBI_ENGINES WHERE BIOBJ_TYPE = (
    SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML'
);

DELETE FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML';
COMMIT;

ALTER TABLE SBI_EVENTS_LOG ADD EVENT_TYPE VARCHAR2(50) DEFAULT 'SCHEDULER' NOT NULL;

UPDATE SBI_EVENTS_LOG SET EVENT_TYPE = (
CASE HANDLER
	WHEN 'it.eng.spagobi.events.handlers.DefaultEventPresentationHandler' THEN 'SCHEDULER'
	WHEN 'it.eng.spagobi.events.handlers.CommonjEventPresentationHandler' THEN 'COMMONJ'
	WHEN 'it.eng.spagobi.events.handlers.TalendEventPresentationHandler' THEN 'ETL'
	WHEN 'it.eng.spagobi.events.handlers.WekaEventPresentationHandler' THEN 'DATA_MINING'
END
);
commit;

ALTER TABLE SBI_EVENTS_LOG DROP COLUMN HANDLER;

-- 21.06.2018 Antonella Giachino
ALTER TABLE SBI_OUTPUT_PARAMETER MODIFY FORMAT_VALUE VARCHAR2(30);

-- 04.07.2017 Filip Milosavljevic

CREATE TABLE SBI_METAMODEL_PAR (
	METAMODEL_PAR_ID INTEGER NOT NULL ,
	PAR_ID INTEGER NOT NULL ,
	METAMODEL_ID INTEGER NOT NULL ,
	LABEL VARCHAR2 (40) NOT NULL ,
	REQ_FL SMALLINT,
	MOD_FL SMALLINT,
	VIEW_FL SMALLINT,
	MULT_FL SMALLINT,
	PROG INTEGER NOT NULL ,
	PARURL_NM VARCHAR2 (20),
	PRIORITY INTEGER,
	COL_SPAN             INTEGER,
    THICK_PERC           INTEGER,
	USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP              VARCHAR2(100),
    USER_DE              VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN       VARCHAR2(10),
    SBI_VERSION_UP       VARCHAR2(10),
    SBI_VERSION_DE       VARCHAR2(10),
    META_VERSION         VARCHAR2(100),
    ORGANIZATION         VARCHAR2(20),
PRIMARY KEY (METAMODEL_PAR_ID)
);

ALTER TABLE SBI_METAMODEL_PAR ADD CONSTRAINT SBI_METAMODEL_PAR_1 FOREIGN KEY (METAMODEL_ID) REFERENCES SBI_META_MODELS (ID);
ALTER TABLE SBI_METAMODEL_PAR ADD CONSTRAINT SBI_METAMODEL_PAR_2 FOREIGN KEY (PAR_ID) REFERENCES SBI_PARAMETERS (PAR_ID);

CREATE TABLE SBI_METAMODEL_PARUSE (
		PARUSE_ID			INTEGER NOT NULL,
		METAMODEL_PAR_ID    INTEGER NOT NULL,
		USE_ID              INTEGER NOT NULL,
		METAMODEL_PAR_FATHER_ID   INTEGER NOT NULL,
		FILTER_OPERATION    VARCHAR2(20) NOT NULL,
		PROG 				INTEGER NOT NULL,
		FILTER_COLUMN       VARCHAR2(30) NOT NULL,
		PRE_CONDITION 		VARCHAR2(10),
	    POST_CONDITION 		VARCHAR2(10),
	    LOGIC_OPERATOR 		VARCHAR2(10),
        USER_IN             VARCHAR2(100) NOT NULL,
        USER_UP             VARCHAR2(100),
        USER_DE             VARCHAR2(100),
        TIME_IN             TIMESTAMP NOT NULL,
        TIME_UP             TIMESTAMP DEFAULT NULL,
        TIME_DE             TIMESTAMP DEFAULT NULL,
        SBI_VERSION_IN      VARCHAR2(10),
        SBI_VERSION_UP      VARCHAR2(10),
        SBI_VERSION_DE      VARCHAR2(10),
        META_VERSION        VARCHAR2(100),
        ORGANIZATION        VARCHAR2(20),
	    PRIMARY KEY(PARUSE_ID)
);

ALTER TABLE SBI_METAMODEL_PARUSE					ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_1 					FOREIGN KEY (METAMODEL_PAR_ID) 			REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID);
ALTER TABLE SBI_METAMODEL_PARUSE 					ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_2 					FOREIGN KEY (USE_ID) 				REFERENCES SBI_PARUSE (USE_ID) ;
ALTER TABLE SBI_METAMODEL_PARUSE 					ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_3 					FOREIGN KEY (METAMODEL_PAR_FATHER_ID)		REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID) ;

CREATE TABLE SBI_METAMODEL_PARVIEW (
	PARVIEW_ID INTEGER NOT NULL,
    METAMODEL_PAR_ID INTEGER NOT NULL,
    METAMODEL_PAR_FATHER_ID  INTEGER NOT NULL,
    OPERATION  VARCHAR(20) NOT NULL,
    COMPARE_VALUE  VARCHAR(200) NOT NULL,
    VIEW_LABEL  VARCHAR(50),
    PROG INTEGER,
       USER_IN              VARCHAR(100) NOT NULL,
       USER_UP              VARCHAR(100),
       USER_DE              VARCHAR(100),
       TIME_IN              TIMESTAMP NOT NULL,
       TIME_UP               TIMESTAMP DEFAULT NULL,
       TIME_DE               TIMESTAMP DEFAULT NULL,
       SBI_VERSION_IN       VARCHAR(10),
       SBI_VERSION_UP       VARCHAR(10),
       SBI_VERSION_DE       VARCHAR(10),
       META_VERSION         VARCHAR(100),
       ORGANIZATION         VARCHAR(20),
  PRIMARY KEY (PARVIEW_ID)
) ;

ALTER TABLE SBI_METAMODEL_PARVIEW 				ADD CONSTRAINT FK_SBI_METAMODEL_PARVIEW_1 				FOREIGN KEY (METAMODEL_PAR_ID) 			REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID);
ALTER TABLE SBI_METAMODEL_PARVIEW 				ADD CONSTRAINT FK_SBI_METAMODEL_PARVIEW_2 				FOREIGN KEY (METAMODEL_PAR_FATHER_ID)		REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID);


---END---

--Filip Milosavljevic 09.07.2018---

ALTER TABLE SBI_METAMODEL_PAR
MODIFY REQ_FL SMALLINT DEFAULT 0
MODIFY MOD_FL SMALLINT DEFAULT 0
MODIFY VIEW_FL SMALLINT DEFAULT 1
MODIFY MULT_FL SMALLINT DEFAULT 0 ;

ALTER TABLE SBI_OBJ_PAR
MODIFY REQ_FL NUMBER DEFAULT 0
MODIFY MOD_FL NUMBER DEFAULT 0
MODIFY VIEW_FL NUMBER DEFAULT 1
MODIFY MULT_FL NUMBER DEFAULT 0;


---END---

--Dragan Pirkovic 09.07.2018---
ALTER TABLE SBI_FEDERATION_DEFINITION ADD OWNER VARCHAR2(100) NULL;


--end--


-- 11.07.2018. Predrag Josipovic
-- STATEMENT START
DELETE FROM SBI_EXPORTERS WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.qbe.QbeDriver')
AND
DOMAIN_ID IN (SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD IN ('PDF', 'RTF', 'JRXML', 'JSON'));

UPDATE SBI_EXPORTERS SET DEFAULT_VALUE = 1 WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.qbe.QbeDriver')
AND
DOMAIN_ID IN (SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD = 'XLS');

commit;
-- STATEMENT END


-- 13.07.2018. Predrag Josipovic
-- STATEMENT START
ALTER TABLE SBI_DATA_SOURCE DROP CONSTRAINT XAK1SBI_DATA_SOURCE DROP INDEX;

ALTER TABLE SBI_DATA_SOURCE ADD CONSTRAINT XAK1SBI_DATA_SOURCE UNIQUE (LABEL);
-- STATEMENT END



-- 11.09.2018. Pirkovic Dragan
-- STATEMENT START


ALTER TABLE SBI_OBJ_PARVIEW RENAME TO SBI_OBJ_PARVIEW_OLD;

CREATE TABLE SBI_OBJ_PARVIEW AS
SELECT ROWNUM AS PARVIEW_ID, T.*
FROM SBI_OBJ_PARVIEW_OLD T;

select * from SBI_OBJ_PARUSE;

ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT PK_SBI_OBJ_PARVIEW PRIMARY KEY(PARVIEW_ID);
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_1 FOREIGN KEY (OBJ_PAR_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID);
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_2 FOREIGN KEY (OBJ_PAR_FATHER_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID);

INSERT INTO hibernate_sequences VALUES ('SBI_OBJ_PARVIEW',
                                                            (SELECT NVL(MAX(t.PARVIEW_ID) + 1, 1) FROM SBI_OBJ_PARVIEW t));

DROP TABLE SBI_OBJ_PARVIEW_OLD;




ALTER TABLE SBI_OBJ_PARUSE RENAME TO SBI_OBJ_PARUSE_OLD;

CREATE TABLE SBI_OBJ_PARUSE AS
SELECT ROWNUM AS PARUSE_ID, T.*
FROM SBI_OBJ_PARUSE_OLD T;

ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT PK_SBI_OBJ_PARUSE PRIMARY KEY(PARUSE_ID);
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_1 FOREIGN KEY (OBJ_PAR_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID);
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_2 FOREIGN KEY (USE_ID) REFERENCES SBI_PARUSE (USE_ID);
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_3 FOREIGN KEY (OBJ_PAR_FATHER_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID);

INSERT INTO hibernate_sequences VALUES ('SBI_OBJ_PARUSE',
                                                            (SELECT NVL(MAX(t.PARUSE_ID) + 1, 1) FROM SBI_OBJ_PARUSE t));

DROP TABLE SBI_OBJ_PARUSE_OLD;

-- STATEMENT END

-- 07/09/2018 Antonella Giachino
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE ROLE_TYPE_ID = (SELECT VALUE_ID FROM SBI_DOMAINS WHERE VALUE_CD = 'TEST_ROLE') AND USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC  WHERE  NAME IN ('TIMESPAN', 'FUNCTIONSCATALOGMANAGEMENT','MANAGECROSSNAVIGATION','EVENTSMANAGEMENT'));
COMMIT;

-- 14/12/2018 Davide Zerbetto
ALTER TABLE SBI_OBJECT_TEMPLATES MODIFY NAME VARCHAR2(1000);

-- 16/01/2019 Antonella Giachino
ALTER TABLE SBI_CROSS_NAVIGATION ADD DESCRIPTION VARCHAR2(200);
ALTER TABLE SBI_CROSS_NAVIGATION ADD BREADCRUMB VARCHAR2(200);

-- 29/01/2019 Pirkovic Dragan

--STATEMENT START
CREATE TABLE SBI_METAMODEL_VIEWPOINTS (
VP_ID INTEGER NOT NULL,
METAMODEL_ID INTEGER NOT NULL,
VP_NAME VARCHAR(40) NOT NULL,
VP_OWNER VARCHAR(40) DEFAULT NULL,
VP_DESC VARCHAR(160) DEFAULT NULL,
VP_SCOPE VARCHAR(20) NOT NULL,
VP_VALUE_PARAMS CLOB,
VP_CREATION_DATE TIMESTAMP  DEFAULT CURRENT_TIMESTAMP,
USER_IN VARCHAR(100) NOT NULL,
USER_UP VARCHAR(100) DEFAULT NULL,
USER_DE VARCHAR(100) DEFAULT NULL,
TIME_IN TIMESTAMP  DEFAULT CURRENT_TIMESTAMP NOT NULL,
TIME_UP TIMESTAMP  DEFAULT NULL,
TIME_DE TIMESTAMP  DEFAULT NULL,
SBI_VERSION_IN VARCHAR(10) DEFAULT NULL,
SBI_VERSION_UP VARCHAR(10) DEFAULT NULL,
SBI_VERSION_DE VARCHAR(10) DEFAULT NULL,
META_VERSION VARCHAR(100) DEFAULT NULL,
ORGANIZATION VARCHAR(20) DEFAULT NULL,
PRIMARY KEY (VP_ID)
) ;

ALTER TABLE SBI_METAMODEL_VIEWPOINTS ADD CONSTRAINT FK_SBI_METAMODEL_VIEWPOINTS_1 FOREIGN KEY (METAMODEL_ID) REFERENCES SBI_META_MODELS (ID);

-- STATEMENT END

--08/02/2019 Dragan Pirkovic
-- begin
CREATE TABLE SBI_NEWS (
	ID INTEGER NOT NULL ,
	NAME varchar(200) DEFAULT NULL,
	DESCRIPTION varchar(400) DEFAULT NULL,
	ACTIVE SMALLINT  DEFAULT '1',
	NEWS varchar(4000) DEFAULT NULL,
	MANUAL SMALLINT  DEFAULT '1',
	EXPIRATION_DATE TIMESTAMP DEFAULT NULL,
	USER_IN varchar(100) NOT NULL,
	USER_UP varchar(100) DEFAULT NULL,
	USER_DE varchar(100) DEFAULT NULL,
	TIME_IN TIMESTAMP NOT NULL,
	TIME_UP TIMESTAMP DEFAULT NULL,
	TIME_DE TIMESTAMP DEFAULT NULL,
	SBI_VERSION_IN varchar(10) DEFAULT NULL,
	SBI_VERSION_UP varchar(10) DEFAULT NULL,
	SBI_VERSION_DE varchar(10) DEFAULT NULL,
	META_VERSION varchar(100) DEFAULT NULL,
	ORGANIZATION varchar(20) DEFAULT NULL,
	CATEGORY_ID INTEGER  DEFAULT NULL,
	PRIMARY KEY (ID),
	CONSTRAINT FK_SBI_DOMAINS_VALUE_ID FOREIGN KEY (CATEGORY_ID) REFERENCES SBI_DOMAINS (VALUE_ID)
)

CREATE TABLE SBI_NEWS_READ (
	ID INTEGER NOT NULL,
	USER_ID varchar(100) NOT NULL,
	NEWS_ID INTEGER NOT NULL,
	USER_IN varchar(100) NOT NULL,
	USER_UP varchar(100) DEFAULT NULL,
	USER_DE varchar(100) DEFAULT NULL,
	TIME_IN TIMESTAMP NOT NULL,
	TIME_UP TIMESTAMP DEFAULT NULL,
	TIME_DE TIMESTAMP DEFAULT NULL,
	SBI_VERSION_IN varchar(10) DEFAULT NULL,
	SBI_VERSION_UP varchar(10) DEFAULT NULL,
	SBI_VERSION_DE varchar(10) DEFAULT NULL,
	META_VERSION varchar(100) DEFAULT NULL,
	ORGANIZATION varchar(20) DEFAULT NULL,
	PRIMARY KEY (ID),
	CONSTRAINT FK_SBI_NEWS_NEWS_ID FOREIGN KEY (NEWS_ID) REFERENCES SBI_NEWS (ID)
	ON DELETE CASCADE
)

CREATE TABLE SBI_NEWS_ROLES (
	NEWS_ID INTEGER NOT NULL,
	EXT_ROLE_ID INTEGER NOT NULL,
	PRIMARY KEY (NEWS_ID,EXT_ROLE_ID),
	CONSTRAINT FK_SBI_EXT_ROLES_EXT_ROLE_ID FOREIGN KEY (EXT_ROLE_ID) REFERENCES SBI_EXT_ROLES (EXT_ROLE_ID)
	ON DELETE CASCADE,
	CONSTRAINT FK_SBI_NEWS_ID FOREIGN KEY (NEWS_ID) REFERENCES SBI_NEWS (ID) ON DELETE CASCADE
)
--end


--12/03/2019 Dragan Pirkovic
-- begin
CREATE TABLE SBI_TAG (
	TAG_ID               INTEGER NOT NULL,
	NAME                 VARCHAR(30) NOT NULL,
	USER_IN              VARCHAR(100) NOT NULL,
	USER_UP              VARCHAR(100),
	USER_DE              VARCHAR(100),
	TIME_IN              TIMESTAMP NOT NULL,
	TIME_UP              TIMESTAMP  DEFAULT NULL,
	TIME_DE              TIMESTAMP  DEFAULT NULL,
	SBI_VERSION_IN       VARCHAR(10),
	SBI_VERSION_UP       VARCHAR(10),
	SBI_VERSION_DE       VARCHAR(10),
	META_VERSION         VARCHAR(100),
	ORGANIZATION         VARCHAR(20),
	PRIMARY KEY (TAG_ID),
	CONSTRAINT XAK1SBI_TAG UNIQUE (NAME, ORGANIZATION)
);


CREATE TABLE SBI_DATA_SET_TAG (
	DS_ID                INTEGER NOT NULL,
	VERSION_NUM	     	 INTEGER NOT NULL,
	ORGANIZATION         VARCHAR(20),
	TAG_ID               INTEGER NOT NULL,
	PRIMARY KEY (DS_ID, VERSION_NUM, ORGANIZATION, TAG_ID),
	FOREIGN KEY (TAG_ID) REFERENCES SBI_TAG (TAG_ID) ,
	FOREIGN KEY (DS_ID, VERSION_NUM, ORGANIZATION) REFERENCES SBI_DATA_SET (DS_ID, VERSION_NUM, ORGANIZATION)

);

-- 08/07/2019 Marco Libanori
ALTER TABLE SBI_USER ADD COLUMN FAILED_LOGIN_ATTEMPTS INT DEFAULT 0 NOT NULL;

-- 17/07/2019 Marco Libanori
ALTER TABLE SBI_PARUSE ADD MAX_LOV_ID INT DEFAULT NULL;

-- 26/08/2019 Pirkovic Dragan
-- remove references to Network engine and document 
DELETE FROM SBI_PRODUCT_TYPE_ENGINE WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.network.NetworkDriver');
DELETE FROM SBI_EXPORTERS WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.network.NetworkDriver');
DELETE FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.network.NetworkDriver';
DELETE FROM SBI_DOMAINS WHERE VALUE_CD = 'NETWORK' AND DOMAIN_CD = 'BIOBJ_TYPE';

-- 16/10/2019
-- Create column for default role ID in SBI_USER table
ALTER TABLE SBI_USER ADD DEFAULT_ROLE_ID INTEGER DEFAULT NULL;
-- Create foreign key between SBI_USER and SBI_EXT_ROLES
ALTER TABLE SBI_USER ADD CONSTRAINT FK_SBI_USER_1 FOREIGN KEY (DEFAULT_ROLE_ID) REFERENCES SBI_EXT_ROLES(EXT_ROLE_ID);

-- 21/10/2019 Alberto Nale
ALTER TABLE SBI_CROSS_NAVIGATION ADD FROM_DOC_ID INTEGER DEFAULT NULL;
-- Create foreign key between SBI_CROSS_NAVIGATION and SBI_OBJECTS
ALTER TABLE SBI_CROSS_NAVIGATION ADD CONSTRAINT FK_SBI_CROSS_NAVIGATION_1 FOREIGN KEY (FROM_DOC_ID) REFERENCES SBI_OBJECTS(BIOBJ_ID);

ALTER TABLE SBI_CROSS_NAVIGATION ADD TO_DOC_ID INTEGER DEFAULT NULL;
-- Create foreign key between SBI_CROSS_NAVIGATION and SBI_OBJECTS
ALTER TABLE SBI_CROSS_NAVIGATION ADD CONSTRAINT FK_SBI_CROSS_NAVIGATION_2 FOREIGN KEY (TO_DOC_ID) REFERENCES SBI_OBJECTS(BIOBJ_ID);

-- 14/02/2020 Alberto Nale
ALTER TABLE SBI_MENU ADD ICON VARCHAR2(1000) NULL;
ALTER TABLE SBI_MENU ADD CUST_ICON VARCHAR2(4000) NULL;

-- 2020/04/10 Alberto Nale
UPDATE SBI_ALERT_LISTENER SET TEMPLATE='angular_1.4/tools/alert/listeners/kpiListener/templates/kpiListener.html' WHERE NAME='KPI Listener';
UPDATE SBI_ALERT_ACTION SET TEMPLATE='angular_1.4/tools/alert/actions/executeETL/templates/executeETL.html' WHERE NAME= 'Execute ETL Document';
UPDATE SBI_ALERT_ACTION SET TEMPLATE='angular_1.4/tools/alert/actions/sendMail/templates/sendMail.html' WHERE NAME= 'Send mail';
UPDATE SBI_ALERT_ACTION SET TEMPLATE='angular_1.4/tools/alert/actions/contextBroker/templates/contextBroker.html' WHERE NAME= 'Context Broker';

-- 9/12/2019 Pirkovic Dragan
-- ALTER TABLE SBI_CROSS_NAVIGATION ADD  POPUP_OPTIONS VARCHAR(4000)  DEFAULT NULL;

--08/06/2020 Andrijana Predojevic
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT XAK1SBI_OBJ_PARUSE UNIQUE (OBJ_PAR_ID,USE_ID,OBJ_PAR_FATHER_ID,FILTER_OPERATION);

--09/06/2020 Andrijana Predojevic
ALTER TABLE SBI_METAMODEL_PARUSE ADD CONSTRAINT XAK1SBI_METAMODEL_PARUSE UNIQUE (METAMODEL_PAR_ID,USE_ID,METAMODEL_PAR_FATHER_ID,FILTER_OPERATION); 

ALTER TABLE SBI_OBJECTS ADD CONSTRAINT XAK2SBI_OBJECTS UNIQUE (NAME, ORGANIZATION);
ALTER TABLE SBI_LOV ADD CONSTRAINT XAK2SBI_LOV UNIQUE (NAME, ORGANIZATION);
ALTER TABLE SBI_PARAMETERS ADD CONSTRAINT XAK2SBI_PARAMETERS UNIQUE (NAME, ORGANIZATION);

--15/06/2020 Andrijana Predojevic
ALTER TABLE SBI_META_MODELS ADD SMART_VIEW SMALLINT DEFAULT 1;

-- 2020-01-12 Matteo Massarotto
ALTER TABLE SBI_DOSSIER_ACTIVITY ADD DOC BLOB NULL; 
ALTER TABLE SBI_DOSSIER_ACTIVITY ADD CONFIG VARCHAR(4000) NULL;

-- 22/12/2020 Marco Balestri
-- CATALOG FUNCTION TABLES UPDATE

-- START

-- CLEAN old tables
DELETE FROM SBI_CATALOG_FUNCTION;
DELETE FROM SBI_FUNCTION_INPUT_VARIABLE;

-- DROP old tables
DROP TABLE SBI_FUNCTION_OUTPUT;
DROP TABLE SBI_FUNCTION_INPUT_DATASET;
DROP TABLE SBI_FUNCTION_INPUT_FILE;

-- ------------------------- TABLE sbi_catalog_function -------------------------
ALTER TABLE SBI_CATALOG_FUNCTION ADD (BENCHMARKS varchar2(4000), FAMILY varchar2(30), ONLINE_SCRIPT varchar2(4000), OFFLINE_SCRIPT_TRAIN varchar2(4000), OFFLINE_SCRIPT_USE varchar2(4000));
ALTER TABLE SBI_CATALOG_FUNCTION DROP (SCRIPT, URL, REMOTE);

-- ----------------------- TABLE sbi_function_input_column -----------------------
CREATE TABLE SBI_FUNCTION_INPUT_COLUMN AS SELECT * FROM SBI_FUNCTION_INPUT_VARIABLE WHERE 1=0;
  
ALTER TABLE SBI_FUNCTION_INPUT_COLUMN RENAME COLUMN VAR_NAME TO COL_NAME;
ALTER TABLE SBI_FUNCTION_INPUT_COLUMN RENAME COLUMN VAR_VALUE TO COL_TYPE;
ALTER TABLE SBI_FUNCTION_INPUT_COLUMN MODIFY  COL_NAME varchar2(100);
ALTER TABLE SBI_FUNCTION_INPUT_COLUMN MODIFY COL_TYPE varchar2(100);

-- ---------------------- TABLE sbi_function_input_variable ---------------------
ALTER TABLE SBI_FUNCTION_INPUT_VARIABLE ADD VAR_TYPE varchar2(100);

-- ---------------------- TABLE sbi_function_output_column -----------------------
CREATE TABLE SBI_FUNCTION_OUTPUT_COLUMN AS SELECT * FROM SBI_FUNCTION_INPUT_COLUMN WHERE 1=0;

ALTER TABLE SBI_FUNCTION_OUTPUT_COLUMN ADD COL_FIELD_TYPE varchar2(100);

-- --------------------------- TABLE sbi_obj_function ---------------------------
CREATE TABLE SBI_OBJ_FUNCTION AS SELECT * FROM SBI_OBJ_DATA_SET WHERE 1=0;

ALTER TABLE SBI_OBJ_FUNCTION DROP COLUMN IS_DETAIL;
ALTER TABLE SBI_OBJ_FUNCTION RENAME COLUMN BIOBJ_DS_ID TO BIOBJ_FUNCTION_ID;
ALTER TABLE SBI_OBJ_FUNCTION RENAME COLUMN DS_ID TO FUNCTION_ID;
ALTER TABLE SBI_OBJ_FUNCTION MODIFY BIOBJ_FUNCTION_ID integer;
ALTER TABLE SBI_OBJ_FUNCTION MODIFY FUNCTION_ID integer;

ALTER TABLE SBI_OBJ_FUNCTION ADD FOREIGN KEY (BIOBJ_ID) REFERENCES SBI_OBJECTS(BIOBJ_ID);
ALTER TABLE SBI_OBJ_FUNCTION ADD FOREIGN KEY (FUNCTION_ID) REFERENCES SBI_CATALOG_FUNCTION(FUNCTION_ID);

-- END

-- 15/02/2021 - Cockpit complexity initializer
CREATE TABLE SBI_COCKPIT_ASSOCIATION (
	SBI_COCKPIT_ASSOCIATION_ID INTEGER NOT NULL ,
	BIOBJ_ID INTEGER NOT NULL ,
	DS_ID_FROM INTEGER NOT NULL ,
	COLUMN_NAME_FROM VARCHAR2(50) NULL,
	DS_ID_TO INTEGER NOT NULL ,
	COLUMN_NAME_TO VARCHAR2(50) NULL,
	USER_IN VARCHAR2(100) NOT NULL ENABLE, 
	USER_UP VARCHAR2(100), 
	USER_DE VARCHAR2(100), 
	TIME_IN TIMESTAMP (6) NOT NULL ENABLE, 
	TIME_UP TIMESTAMP (6) DEFAULT NULL, 
	TIME_DE TIMESTAMP (6) DEFAULT NULL, 
	SBI_VERSION_IN VARCHAR2(10), 
	SBI_VERSION_UP VARCHAR2(10), 
	SBI_VERSION_DE VARCHAR2(10), 
	META_VERSION VARCHAR2(100), 
	ORGANIZATION VARCHAR2(20),
	PRIMARY KEY (SBI_COCKPIT_ASSOCIATION_ID)
);
ALTER TABLE SBI_COCKPIT_ASSOCIATION ADD CONSTRAINT FK_SBI_COCKPIT_ASSOCIATION_1 FOREIGN KEY (BIOBJ_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID);

CREATE TABLE SBI_COCKPIT_WIDGET (
	SBI_COCKPIT_WIDGET_ID INTEGER NOT NULL ,
	BIOBJ_ID INTEGER NOT NULL ,
	TAB VARCHAR2(50) NULL,
	WIDGET_TYPE VARCHAR2(50) NULL,
	DS_ID INTEGER NULL,
	ASSOCIATIVE SMALLINT NULL,
	CACHE SMALLINT NULL,
	FILTERS SMALLINT NULL,
	USER_IN VARCHAR2(100) NOT NULL ENABLE, 
	USER_UP VARCHAR2(100), 
	USER_DE VARCHAR2(100), 
	TIME_IN TIMESTAMP (6) NOT NULL ENABLE, 
	TIME_UP TIMESTAMP (6) DEFAULT NULL, 
	TIME_DE TIMESTAMP (6) DEFAULT NULL, 
	SBI_VERSION_IN VARCHAR2(10), 
	SBI_VERSION_UP VARCHAR2(10), 
	SBI_VERSION_DE VARCHAR2(10), 
	META_VERSION VARCHAR2(100), 
	ORGANIZATION VARCHAR2(20),
	PRIMARY KEY (SBI_COCKPIT_WIDGET_ID)
);
ALTER TABLE SBI_COCKPIT_WIDGET ADD CONSTRAINT FK_SBI_COCKPIT_WIDGET_1 FOREIGN KEY (BIOBJ_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID);

-- 06/04/2021
UPDATE SBI_CONFIG SC SET VALUE_CHECK = 'it-IT,en-US,fr-FR,es-ES,pt-BR,en-GB,zh-Hans-CN,de-DE' WHERE LABEL = 'SPAGOBI.LANGUAGE_SUPPORTED.LANGUAGES';
UPDATE SBI_CONFIG SC SET VALUE_CHECK = 'en-US' WHERE LABEL = 'SPAGOBI.LANGUAGE_SUPPORTED.LANGUAGE.default';
UPDATE SBI_DOMAINS SET VALUE_CD = 'it-IT' WHERE DOMAIN_CD = 'LANG' AND VALUE_NM = 'Italian' AND DOMAIN_NM = 'Language ISO code';
UPDATE SBI_DOMAINS SET VALUE_CD = 'en-US' WHERE DOMAIN_CD = 'LANG' AND VALUE_NM = 'English' AND DOMAIN_NM = 'Language ISO code';
UPDATE SBI_DOMAINS SET VALUE_CD = 'es-ES' WHERE DOMAIN_CD = 'LANG' AND VALUE_NM = 'Spanish' AND DOMAIN_NM = 'Language ISO code';
UPDATE SBI_DOMAINS SET VALUE_CD = 'fr-FR' WHERE DOMAIN_CD = 'LANG' AND VALUE_NM = 'French' AND DOMAIN_NM = 'Language ISO code';
UPDATE SBI_DOMAINS SET VALUE_CD = 'pt-BR' WHERE DOMAIN_CD = 'LANG' AND VALUE_NM = 'Portoguese' AND DOMAIN_NM = 'Language ISO code';

ALTER TABLE SBI_MENU ADD (CUST_ICON_CLOB CLOB);
UPDATE SBI_MENU SET CUST_ICON_CLOB = CUST_ICON;
ALTER TABLE SBI_MENU DROP COLUMN CUST_ICON;
ALTER TABLE SBI_MENU RENAME COLUMN CUST_ICON_CLOB TO CUST_ICON;

CREATE TABLE SBI_WIDGET_GALLERY (
  UUID CHAR(36) NOT NULL, -- primary key
  NAME VARCHAR(200) NOT NULL,
  DESCRIPTION VARCHAR(500) NULL,
  TYPE VARCHAR(45) NULL, -- HTML/CUSTOM CHART/PYTHON/R
  PREVIEW_IMAGE BLOB NULL, -- binary of preview file
  TEMPLATE CLOB NULL, -- text with template as a JSON
  AUTHOR VARCHAR(100) NULL,
  USAGE_COUNTER INT NULL, -- counter to see how many times the widgets was used
	USER_IN              VARCHAR2(100) NOT NULL,
		USER_UP              VARCHAR2(100),
		USER_DE              VARCHAR2(100),
		TIME_IN              TIMESTAMP NOT NULL,
		TIME_UP              TIMESTAMP DEFAULT NULL,
		TIME_DE              TIMESTAMP DEFAULT NULL,
		SBI_VERSION_IN       VARCHAR2(10),
		SBI_VERSION_UP       VARCHAR2(10),
		SBI_VERSION_DE       VARCHAR2(10),
		META_VERSION         VARCHAR2(100),
		ORGANIZATION         VARCHAR2(20),
     OUTPUT_TYPE        VARCHAR2(100),
 CONSTRAINT  XAK1SBI_WIDGET_GALLERY UNIQUE (NAME, ORGANIZATION),
  PRIMARY KEY (UUID, ORGANIZATION)
);

CREATE TABLE SBI_WIDGET_GALLERY_TAGS (
  WIDGET_ID CHAR(36) NOT NULL, -- widget id reference
  TAG VARCHAR(50) NOT NULL, -- tag name
 USER_IN              VARCHAR2(100) NOT NULL,
		USER_UP              VARCHAR2(100),
		USER_DE              VARCHAR2(100),
		TIME_IN              TIMESTAMP NOT NULL,
		TIME_UP              TIMESTAMP DEFAULT NULL,
		TIME_DE              TIMESTAMP DEFAULT NULL,
		SBI_VERSION_IN       VARCHAR2(10),
		SBI_VERSION_UP       VARCHAR2(10),
		SBI_VERSION_DE       VARCHAR2(10),
		META_VERSION         VARCHAR2(100),
		ORGANIZATION         VARCHAR2(20),
  PRIMARY KEY  (WIDGET_ID, ORGANIZATION),
  CONSTRAINT FK_SBI_WIDGET_GALLERY_TAGS_1 FOREIGN KEY (WIDGET_ID, ORGANIZATION) REFERENCES SBI_WIDGET_GALLERY (UUID, ORGANIZATION) ON DELETE CASCADE
);

-- 2021/07/26
ALTER TABLE SBI_ALERT_ACTION DROP COLUMN TEMPLATE CASCADE;
ALTER TABLE SBI_ALERT_LISTENER DROP COLUMN TEMPLATE CASCADE;

-- 2021/08/27
-- UPDATED SBI_EXT_USER_ROLES ORGANIZATION FIELD WHERE NULL
UPDATE SBI_EXT_USER_ROLES SET ORGANIZATION = (SELECT ORGANIZATION FROM SBI_USER WHERE ID = SBI_EXT_USER_ROLES.ID), TIME_UP = CURRENT_TIMESTAMP 
WHERE SBI_EXT_USER_ROLES.ORGANIZATION IS NULL;

-- 2021/10/14
ALTER TABLE SBI_DATA_SET ADD (DS_DERIVED_ID NUMBER(38,0));

-- 2022/02/08
CREATE TABLE SBI_ORGANIZATION_THEME (
	UUID 				 VARCHAR(36) NOT NULL,
	ORGANIZATION_ID 	 INTEGER NOT NULL,
	THEME_NAME 			 VARCHAR(255) NOT NULL,
	CONFIG 				 CLOB NULL,
	ACTIVE 				 SMALLINT DEFAULT 0,
	USER_IN              VARCHAR2(100) NOT NULL,
	USER_UP              VARCHAR2(100),
	USER_DE              VARCHAR2(100),
	TIME_IN              TIMESTAMP NOT NULL,
	TIME_UP              TIMESTAMP DEFAULT NULL,
	TIME_DE              TIMESTAMP DEFAULT NULL,
	SBI_VERSION_IN       VARCHAR2(10),
	SBI_VERSION_UP       VARCHAR2(10),
	SBI_VERSION_DE       VARCHAR2(10),
	ORGANIZATION         VARCHAR2(20),
	PRIMARY KEY (UUID, ORGANIZATION),
	CONSTRAINT FK_ORGANIZATION_1 FOREIGN KEY (ORGANIZATION_ID) REFERENCES SBI_ORGANIZATIONS(ID)
);
